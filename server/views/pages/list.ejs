<!doctype html>
<html lang="en">

<head>
	<!-- Required meta tags -->
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<title>Photo Picker</title>

	<link href="/styles.css?v=0.2.2" rel="stylesheet">

	<script src="/js/jquery.slim.min.js"></script>
	<script src="/qrcode.js"></script>

	<script src="/js/picker.js?v=0.2.2"></script>

</head>

<body>


	<div id="modal" class="relative z-10" style="display:none;">

		<div class="fixed inset-0 bg-gray-50 bg-opacity-75 transition-opacity" aria-hidden="true"></div>

		<div class="fixed inset-8 z-10 bg-white border border-gray-400 rounded-lg overflow-y-auto">

			<button onclick="closeModal()"
				class='px-2 py-1 m-2 border border-red-500 text-red-500 hover:text-white hover:bg-red-500 hover:border-red-800 rounded-md text-sm'>Close</button>
			<div id="downloadVideo" class="p-2 text-lg text-gray-500" style="display: none;">Fetching video...</div>

			<div class="flex flex-col items-center p-4 text-center sm:items-center sm:p-0">

				<img id="largeImg" style="display: none;" />
				<video id="largeVideo" controls style="display: none;" />

				<!-- YouTube Upload Button -->
				<button id="uploadToYouTube" onclick="uploadVideoToYouTube()" style="display: none;"
					class="mt-4 px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">
					üì§ Upload to YouTube
				</button>

				<table id="metadataTable">

				</table>
			</div>
		</div>

	</div>
	</div>


	<div class="text-right">
		<a href="/disconnect"
			class="inline-block cursor-pointer py-1 px-2 m-2 border border-gray-400 hover:border-blue-400 hover:bg-blue-50 rounded-md text-sm">
			Disconnect from Google Photos
		</a>
	</div>


	<div class="text-left">
		<h1 href="/disconnect" class="text-xl text-gray-500 px-10 py-2">
			Selected media items
			<a href="/new_session" class="text-blue-500 ml-4 text-sm hover:underline">Change selection</a>
		</h1>
		<div class="mx-10 mt-8 text-xs text-gray-500 font-bold">Click on an image to see media item details</div>
	</div>


	<div>
		<p id="loading" class="p-16 text-gray-500 text-lg">Loading...</p>
	</div>

	<div id="imageList" class="p-8 flex flex-wrap">

	</div>


	<div class="flex justify-between">
		<div class="px-8">
			<button id="prev" onclick="history.back()" style="display:none;"
				class="cursor-pointer rounded-md m-2 py-2 px-4 text-sm border border-blue-500 text-blue-800 hover:text-white hover:bg-blue-500 hover:border-blue-800">Previous</button>
		</div>

		<div class="px-8">
			<a id="next" href="/list" style="display:none;"
				class="cursor-pointer rounded-md m-2 py-2 px-4 text-sm border border-blue-500 text-blue-800 hover:text-white hover:bg-blue-500 hover:border-blue-800">Next</a>
		</div>

	</div>

	<footer class="mt-12 mb-8 text-center text-sm text-gray-500">
		<p>
			v0.2.2 (Beta) |
			<a href="https://kuancheen.github.io/md-viewer/?https://github.com/kuancheen/photos-picker-sample/blob/main/README.md"
				target="_blank" class="hover:underline">README</a> |
			<a href="https://kuancheen.github.io/md-viewer/?https://github.com/kuancheen/photos-picker-sample/blob/main/CHANGELOG.md"
				target="_blank" class="hover:underline">CHANGELOG</a> |
			&copy; <span id="year">2024-2025</span> <a href="https://github.com/kuancheen" target="_blank"
				class="hover:underline">Kuan Cheen Lim</a> |
			<img src="https://hits.sh/kuancheen.github.io/photos-picker-sample.svg?view=today-total&style=flat-square&label=üëÅÔ∏è%20Views&extraCount=0&color=6366f1"
				alt="Hits" class="inline-block align-middle ml-2">
		</p>
	</footer>

</body>

<script type="text/javascript">

	let mediaItems = []

	const urlParams = new URLSearchParams(window.location.search);
	let thisPageToken = urlParams.get("pageToken")
	let nextPageToken = null

	if (thisPageToken) {
		$("#prev").show()
	}

	const loadList = async () => {
		const imageResponse = await fetchImages(thisPageToken)

		if ('nextPageToken' in imageResponse.images) {
			nextPageToken = imageResponse.images.nextPageToken
			$("#next").attr("href", "/list?pageToken=" + nextPageToken)
			$("#next").show()
		}

		mediaItems = imageResponse.images.mediaItems

		$("#loading").hide()

		mediaItems.forEach((mediaItem, idx) => {
			const imgId = `mediaItem-${idx}`
			const isVideo = mediaItem.type === 'VIDEO';
			const videoIcon = isVideo ? '<div class="absolute inset-0 flex items-center justify-center pointer-events-none"><span class="text-white text-4xl shadow-lg">‚ñ∂Ô∏è</span></div>' : '';

			$("#imageList").append(`
				<div class="relative inline-block m-2">
					${videoIcon}
					<img class='thumbnail cursor-pointer rounded-md' id='${imgId}' />
				</div>
			`)

			// Select thumbnail size to display in list (here that is max 128px x 128px)
			const sizeParams = "=w128-h128"

			loadImageIntoImg(imgId, mediaItem.mediaFile.baseUrl + sizeParams)
		})

	}

	loadList()


	$(document).on('click', '.thumbnail', e => {
		e.stopPropagation();
		e.stopImmediatePropagation();

		const imageClickedId = parseInt(e.target.id.replace(/.*\-/, ""))

		const mediaItem = mediaItems[imageClickedId]

		let metadata = []

		$("#metadataTable").html("")

		const meta = mediaItem.mediaFile.mediaFileMetadata

		if (meta) {
			Object.keys(meta).forEach(key => {
				const value = meta[key]
				if (typeof value === 'object') {
					Object.keys(value).forEach(value_key => {
						metadata.push([value_key, value[value_key]])
					})
				} else {
					metadata.push([key, value])
				}
			})

			let metadatatags = []
			metadata.forEach(value => {
				metadatatags.push(`<tr><td>${value[0]}</td><td>${value[1]}</td></tr>`)
			})

			$("#metadataTable").html(metadatatags.join())

		}

		$("#largeImg").hide()
		$("#largeVideo").hide()
		if (mediaItem.type == "VIDEO") {
			loadImageIntoVideo("largeVideo", mediaItem.mediaFile.baseUrl)
			// Show YouTube upload button for videos
			$("#uploadToYouTube").show()
			$("#uploadToYouTube").data('mediaItem', mediaItem)
		} else {
			loadImageIntoImg("largeImg", mediaItem.mediaFile.baseUrl)
			$("#uploadToYouTube").hide()
		}
		$("#modal").show()
	})



	const uploadVideoToYouTube = async () => {
		const mediaItem = $('#uploadToYouTube').data('mediaItem')

		if (!mediaItem || mediaItem.type !== 'VIDEO') {
			alert('Please select a video to upload')
			return
		}

		// Prompt for video details
		const title = prompt('Enter video title:', mediaItem.mediaFile.filename || 'Untitled Video')
		if (!title) return

		const description = prompt('Enter video description (optional):', '')
		const privacy = prompt('Enter privacy status (public/unlisted/private):', 'unlisted')

		// Disable button and show loading
		const button = $('#uploadToYouTube')
		button.prop('disabled', true)
		button.text('Uploading...')

		try {
			const response = await fetch('/upload-to-youtube', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify({
					baseUrl: mediaItem.mediaFile.baseUrl,
					title: title,
					description: description,
					privacy: privacy
				})
			})

			const result = await response.json()

			if (response.ok && result.success) {
				alert(`‚úì Video uploaded successfully!\nVideo ID: ${result.videoId}\nTitle: ${result.title}`)
				button.text('‚úì Uploaded')
				button.css('background', '#22c55e')
			} else {
				throw new Error(result.error || 'Upload failed')
			}
		} catch (error) {
			console.error('Upload error:', error)
			alert(`Upload failed: ${error.message}`)
			button.prop('disabled', false)
			button.text('üì§ Upload to YouTube')
		}
	}

	const closeModal = () => {
		$('#modal').hide()
	}

</script>

</html>